<!DOCTYPE html>
<html lang="en">

<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
    
  <meta name="description" content="des 吴泽鑫的博客" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    分布式部署下的唯一ID生成问题 |  Xeme&#39;s Blog
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/images/logo/x.png" />
  
  
<link rel="stylesheet" href="/css/style.css">

  
<script src="/js/pace.min.js"></script>


  

  

<link rel="alternate" href="/atom.xml" title="Xeme's Blog" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

</html>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    <main class="content">
      <section class="outer">
  <article id="post-分布式部署下的唯一ID生成问题" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  分布式部署下的唯一ID生成问题
</h1>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/09/21/%E5%88%86%E5%B8%83%E5%BC%8F%E9%83%A8%E7%BD%B2%E4%B8%8B%E7%9A%84%E5%94%AF%E4%B8%80ID%E7%94%9F%E6%88%90%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2020-09-21T10:00:00.000Z" itemprop="datePublished">2020-09-21</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
  </div>

      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">1.5k字</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">7分钟</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h2 id="分布式部署下的唯一ID生成问题"><a href="#分布式部署下的唯一ID生成问题" class="headerlink" title="分布式部署下的唯一ID生成问题"></a>分布式部署下的唯一ID生成问题</h2><p>近期发现在分布式情况下，生成一个系统内唯一的与其它数据绝对不重合的ID如果要自己去实现是一个比较复杂的问题，若要使用ID自增的方法，可能怕同时有两用户新建ID ， 第一个人从数据库里读取了最大号的ID+1，但还没来得及写入，后一个人又去取了最大号的ID+1，然后就出现了重合的情况；所以可能会想到使用redis分布式锁；但是新建ID可能会是一个比较高频的操作，频繁的建、解锁可能会造成性能开销</p>
<a id="more"></a>

<blockquote>
<p>Imagine you’re writing a <a href="https://github.com/kjk/quicknotes" target="_blank" rel="noopener">note taking</a> application.</p>
<p>Each note needs a unique id.</p>
<p>Generating unique ids is easy if you can coordinate.</p>
<p>The simplest way is to get database to do it: use <code>AUTOINCREMENT</code> column and the database will generate unique id when you insert a new <code>note</code> row into a table.</p>
<p>What if you can’t coordinate?</p>
<p>For example, you want the app to also generate unique note id when offline, when it cannot talk to the database.</p>
<p>The requirement of non-coordinated generation of unique ids comes up often in distributed systems.</p>
<p>A simple solution is to generate a random id. If you give it 16 bytes of randomness, the chances of generating the same random number are non-existent.</p>
<p>It’s such a common problem that over 30 years ago we created a standard for this called <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier" target="_blank" rel="noopener">UUID/GUID</a>.</p>
</blockquote>
<p>在最极端情况下，某个分布式设备无法访问数据库时，如何生成一个唯一ID</p>
<blockquote>
<p>We can do better than GUID. A good random unique id:</p>
<ul>
<li>is unique; we can’t skip the basics</li>
<li>can be sorted by its string representation</li>
<li>is time-clustered i.e. ids generated at the same time are close to each other when sorted</li>
<li>string representation can be used as part of URL without escaping</li>
<li>the shorter, the better</li>
</ul>
</blockquote>
<p>Go已经有一些开源的包支持这个唯一ID的生成问题</p>
<table>
<thead>
<tr>
<th>Package</th>
<th>Id</th>
<th>Format</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://github.com/segmentio/ksuid" target="_blank" rel="noopener">github.com/segmentio/ksuid</a></td>
<td><code>**0pPKHjWprnVxGH7dEsAoXX2YQvU**</code></td>
<td>4 bytes of time (seconds) + 16 random bytes</td>
</tr>
<tr>
<td><a href="https://github.com/rs/xid" target="_blank" rel="noopener">github.com/rs/xid</a></td>
<td><code>**b50vl5e54p1000fo3gh0**</code></td>
<td>4 bytes of time (seconds) + 3 byte machine id + 2 byte process id + 3 bytes random</td>
</tr>
<tr>
<td><a href="https://github.com/kjk/betterguid" target="_blank" rel="noopener">github.com/kjk/betterguid</a></td>
<td><code>**-Kmdih_fs4ZZccpx2Hl1**</code></td>
<td>8 bytes of time (milliseconds) + 9 random bytes</td>
</tr>
<tr>
<td><a href="https://github.com/sony/sonyflake" target="_blank" rel="noopener">github.com/sony/sonyflake</a></td>
<td><code>**20f8707d6000108**</code></td>
<td>~6 bytes of time (10 ms) + 1 byte sequence + 2 bytes machine id</td>
</tr>
<tr>
<td><a href="https://github.com/oklog/ulid" target="_blank" rel="noopener">github.com/oklog/ulid</a></td>
<td><code>**01BJMVNPBBZC3E36FJTGVF0C4S**</code></td>
<td>6 bytes of time (milliseconds) + 8 bytes random</td>
</tr>
<tr>
<td><a href="https://github.com/chilts/sid" target="_blank" rel="noopener">github.com/chilts/sid</a></td>
<td><code>**1JADkqpWxPx-4qaWY47~FqI**</code></td>
<td>8 bytes of time (ns) + 8 random bytes</td>
</tr>
<tr>
<td><a href="https://github.com/lithammer/shortuuid" target="_blank" rel="noopener">https://github.com/lithammer/shortuuid</a></td>
<td><code>dwRQAc68PhHQh4BUnrNsoS</code></td>
<td>UUIDv4 or v5, encoded in a more compact way</td>
</tr>
<tr>
<td><a href="https://github.com/satori/go.uuid" target="_blank" rel="noopener">github.com/satori/go.uuid</a></td>
<td><code>**5b52d72c-82b3-4f8e-beb5-437a974842c**</code></td>
<td>UUIDv4 from <a href="http://tools.ietf.org/html/rfc4122" target="_blank" rel="noopener">RFC 4112</a> for comparison</td>
</tr>
<tr>
<td><a href="https://github.com/google/uuid" target="_blank" rel="noopener">https://github.com/google/uuid</a></td>
<td><code>**c01d7cf6-ec3f-47f0-9556-a5d6e9009a43**</code></td>
<td>UUIDv4</td>
</tr>
</tbody></table>
<p>其中 <code>rs/xid</code> 与  <code>segmentio/ksuid</code> 是比较好的解决方案</p>
<h3 id="xid"><a href="#xid" class="headerlink" title="xid"></a>xid</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><blockquote>
<p>// Package xid is a globally unique id generator suited for web scale<br>//<br>// Xid is using Mongo Object ID algorithm to generate globally unique ids:<br>// <a href="https://docs.mongodb.org/manual/reference/object-id/" target="_blank" rel="noopener">https://docs.mongodb.org/manual/reference/object-id/</a></p>
</blockquote>
<p>xid使用了mongodb中的算法</p>
<blockquote>
<p>//   - 4-byte value representing the seconds since the Unix epoch,<br>//   - 3-byte machine identifier,<br>//   - 2-byte process id, and<br>//   - 3-byte counter, starting with a random value.</p>
</blockquote>
<p>编码格式：4 bytes of time (seconds) + 3 byte machine id + 2 byte process id + 3 bytes random</p>
<blockquote>
<p>// The binary representation of the id is compatible with Mongo 12 bytes Object IDs.<br>// The string representation is using base32 hex (w/o padding) for better space efficiency<br>// when stored in that form (20 bytes). The hex variant of base32 is used to retain the<br>// sortable property of the id.<br>//<br>// Xid doesn’t use base64 because case sensitivity and the 2 non alphanum chars may be an<br>// issue when transported as a string between various systems. Base36 wasn’t retained either<br>// because 1/ it’s not standard 2/ the resulting size is not predictable (not bit aligned)<br>// and 3/ it would not remain sortable. To validate a base32 <code>xid</code>, expect a 20 chars long,<br>// all lowercase sequence of <code>a</code> to <code>v</code> letters and <code>0</code> to <code>9</code> numbers (<code>[0-9a-v]{20}</code>).</p>
</blockquote>
<p>生成的ID不区分大小写，因为在分布式情况下，这些ID很可能在不同环境下都会有所使用，而：</p>
<p>1 某些环境可能不区分大小写，比如mysql可能被配置为大小写不敏感</p>
<p>2 有些情况下，首字母的大小写可能会存在歧义，比如Golang的中struct内的字段被翻译至JSON时，可能首字母的大小写会被转换</p>
<p>因此在分布式场景下，ID定义为大小写不敏感或许是比较明智的选择</p>
<blockquote>
<p>// UUID is 16 bytes (128 bits), snowflake is 8 bytes (64 bits), xid stands in between<br>// with 12 bytes with a more compact string representation ready for the web and no<br>// required configuration or central generation server.</p>
</blockquote>
<p>ID在满足使用的前提下，the shorter, the better</p>
<blockquote>
<p>// Features:<br>//<br>//   - Size: 12 bytes (96 bits), smaller than UUID, larger than snowflake<br>//   - Base32 hex encoded by default (16 bytes storage when transported as printable string)<br>//   - Non configured, you don’t need set a unique machine and/or data center id<br>//   - K-ordered<br>//   - Embedded time with 1 second precision<br>//   - Unicity guaranteed for 16,777,216 (24 bits) unique ids per second and per host/process</p>
</blockquote>
<p>保证每个主机/进程每秒有16,777,216(24位)唯一id，大多数情况下都够用了</p>
<blockquote>
<p>// Best used with xlog’s RequestIDHandler (<a href="https://godoc.org/github.com/rs/xlog#RequestIDHandler" target="_blank" rel="noopener">https://godoc.org/github.com/rs/xlog#RequestIDHandler</a>).<br>//<br>// References:<br>//<br>//   - <a href="http://www.slideshare.net/davegardnerisme/unique-id-generation-in-distributed-systems" target="_blank" rel="noopener">http://www.slideshare.net/davegardnerisme/unique-id-generation-in-distributed-systems</a><br>//   - <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Universally_unique_identifier</a><br>//   - <a href="https://blog.twitter.com/2010/announcing-snowflake" target="_blank" rel="noopener">https://blog.twitter.com/2010/announcing-snowflake</a></p>
</blockquote>
<h4 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h4><p>xid非常友好，使用很简单，且Non configured，不用为配置烦恼</p>
<p><strong>安装</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com&#x2F;rs&#x2F;xid</span><br></pre></td></tr></table></figure>

<p><strong>使用</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/rs/xid"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">guid := xid.New()  <span class="comment">//生成一个新的ID 存储时是12个字节</span></span><br><span class="line"><span class="comment">//println(guid.String()) //使用这个新ID 输出的是20个字节的字符串</span></span><br><span class="line"><span class="comment">//注：</span></span><br><span class="line"><span class="comment">// id的二进制表示与Mongo 12字节对象id兼容。</span></span><br><span class="line"><span class="comment">// 字符串表示使用base32十六进制(w/o填充)来提高空间效率</span></span><br><span class="line"><span class="comment">// 以string形式存储时(20字节)。十六进制版本的base32是用来保持id的可排序属性。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一些信息的获取</span></span><br><span class="line">guid.Machine()</span><br><span class="line">guid.Pid()</span><br><span class="line">guid.Time()</span><br><span class="line">guid.Counter()</span><br></pre></td></tr></table></figure>

<h4 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h4><blockquote>
<p>from: <a href="https://github.com/rs/xid" target="_blank" rel="noopener">https://github.com/rs/xid</a></p>
<p>Benchmark against Go <a href="https://github.com/satori" target="_blank" rel="noopener">Maxim Bublis</a>‘s <a href="https://github.com/satori/go.uuid" target="_blank" rel="noopener">UUID</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;BenchmarkXID        	20000000	        91.1 ns&#x2F;op	      32 B&#x2F;op	       1 allocs&#x2F;op</span><br><span class="line">&gt;BenchmarkXID-2      	20000000	        55.9 ns&#x2F;op	      32 B&#x2F;op	       1 allocs&#x2F;op</span><br><span class="line">&gt;BenchmarkXID-4      	50000000	        32.3 ns&#x2F;op	      32 B&#x2F;op	       1 allocs&#x2F;op</span><br><span class="line">&gt;BenchmarkUUIDv1     	10000000	       204 ns&#x2F;op	      48 B&#x2F;op	       1 allocs&#x2F;op</span><br><span class="line">&gt;BenchmarkUUIDv1-2   	10000000	       160 ns&#x2F;op	      48 B&#x2F;op	       1 allocs&#x2F;op</span><br><span class="line">&gt;BenchmarkUUIDv1-4   	10000000	       195 ns&#x2F;op	      48 B&#x2F;op	       1 allocs&#x2F;op</span><br><span class="line">&gt;BenchmarkUUIDv4     	 1000000	      1503 ns&#x2F;op	      64 B&#x2F;op	       2 allocs&#x2F;op</span><br><span class="line">&gt;BenchmarkUUIDv4-2   	 1000000	      1427 ns&#x2F;op	      64 B&#x2F;op	       2 allocs&#x2F;op</span><br><span class="line">&gt;BenchmarkUUIDv4-4   	 1000000	      1452 ns&#x2F;op	      64 B&#x2F;op	       2 allocs&#x2F;op</span><br></pre></td></tr></table></figure>



<p>UUIDv1 requires a global lock, hence the performance degradation as we add more CPUs.</p>
</blockquote>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://thexeme.github.io/2020/09/21/%E5%88%86%E5%B8%83%E5%BC%8F%E9%83%A8%E7%BD%B2%E4%B8%8B%E7%9A%84%E5%94%AF%E4%B8%80ID%E7%94%9F%E6%88%90%E9%97%AE%E9%A2%98/" data-id="ckfdcfnaf00002ctx1vt6dxgp"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">后端开发</a></li></ul>

    </footer>

  </div>

  
  
  <nav class="article-nav">
    
    
      <a href="/2020/07/01/%E5%AE%9E%E4%B9%A0-%E8%99%8E%E7%89%99/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">实习-虎牙</div>
      </a>
    
  </nav>


  

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2019-2020
        TheXeme
      </li>
      <li>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <ul class="list-inline">
  <li>PV:<span id="busuanzi_value_page_pv"></span></li>
  <li>UV:<span id="busuanzi_value_site_uv"></span></li>
</ul>
        
      </li>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
    <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
    
    <aside class="sidebar">
      
        <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/logo/xeme.png" alt="Xeme&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      </aside>
      <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>谢谢，但是暂时无需打赏~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/pay/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/pay/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
      
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




  
<script src="/js/tocbot.min.js"></script>

  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
			onClick: (e) => {
      	document.getElementById(e.target.innerText).scrollIntoView()
      	return false;
    	}
    });
  </script>


<script>
  var ayerConfig = {
    mathjax: 
  }
</script>


<script src="/js/ayer.js"></script>


<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">



<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>
  
  

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>